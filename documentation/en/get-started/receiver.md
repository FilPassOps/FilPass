# Receiver

## Table of Contents

- [Receiver](#receiver)
  - [Table of Contents](#table-of-contents)
  - [Overview](#overview)
  - [Submitting Tickets](#submitting-tickets)
    - [Important: Token Management](#important-token-management)
    - [API Endpoint](#api-endpoint)
    - [Request Body](#request-body)
    - [Example Request](#example-request)
    - [Response](#response)
      - [Successful Response (200 OK)](#successful-response-200-ok)
      - [Error Response (4xx/5xx)](#error-response-4xx5xx)
  - [Token Verification](#token-verification)
  - [Important Notes](#important-notes)
  - [Need Help?](#need-help)

## Overview

This guide explains how to handle and submit tickets as a receiver in the FilPass system.

## Submitting Tickets

When you receive a ticket token from a user, you'll need to submit it to the FilPass system for validation and processing.

<code>ℹ️ You can check more information about the ticket token in [Ticket Specifications](../guide/ticket-specifications.md).</code>

### Important: Token Management

As a Storage Provider, you should always:

1. **Store the last accepted token**: Keep track of the most recently accepted token for each lane/contract combination
2. **Validate token amounts**: Only accept new tokens where the `lane_total_amount` is greater than the last accepted token's amount
3. **Calculate actual payment**: The actual payment amount for a new ticket can be calculated as:
   ```
   actual_amount = new_ticket.lane_total_amount - last_accepted_ticket.lane_total_amount
   ```

This ensures proper payment tracking and prevents double-spending or out-of-order ticket submissions.

### API Endpoint

- **URL**: `https://filpass-domain/api/external/submit-ticket`
- **Method**: POST
- **Content-Type**: application/json

### Request Body

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // JWT token received from the user
}
```

### Example Request

Here's an example using cURL:

```bash
curl -X POST \
  'https://filpass-domain/api/external/submit-ticket' \
  -H 'Content-Type: application/json' \
  -d '{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }'
```

### Response

The API will respond with a status indicating whether the ticket was successfully submitted.

#### Successful Response (200 OK)
```json
{
    "status": "Success",
}
```

#### Error Response (4xx/5xx)
```json
{
    "status": "error",
    "message": "Error description"
}
```

## Token Verification

Storage Providers can verify that tickets were genuinely generated by FilPass before processing them. This can be done by verifying the JWT signature using FilPass's public key:

1. Extract the `kid` (Key ID) from the JWT token header
2. Fetch FilPass's public keys from: `https://filpass-domain/.well-known/jwks.json`
3. Use the public key matching the token's `kid` to verify the JWT signature

Here's an example using Node.js and the `jsonwebtoken` library:

```javascript
const jwt = require('jsonwebtoken');
const axios = require('axios');

async function verifyToken(token) {
  // Fetch JWKS (JSON Web Key Set)
  const jwksResponse = await axios.get('https://filpass-domain/.well-known/jwks.json');
  const jwks = jwksResponse.data;

  // Get token's key id
  const decodedToken = jwt.decode(token, { complete: true });
  const kid = decodedToken.header.kid;

  // Find matching public key
  const key = jwks.keys.find(k => k.kid === kid);

  // Verify token
  try {
    const verified = jwt.verify(token, key.publicKey);
    return verified;
  } catch (error) {
    throw new Error('Invalid token signature');
  }
}
```

## Important Notes

1. The JWT token must be submitted exactly as received from the user
2. Tokens are one-time use only
3. Expired tokens will be rejected
4. There is a limit of 10 submit-ticket requests per day (this limit may be adjusted based on system configuration)
5. Make sure to handle API errors appropriately in your implementation

## Need Help?

If you encounter any issues or need assistance, please contact our support team at platform-name@company.com.